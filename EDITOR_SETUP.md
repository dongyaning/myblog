# 在线编辑器设置指南

## 安装依赖

在线编辑器已实现完成，但需要先安装新的依赖：

```bash
pnpm install
```

新增的依赖：

- `gray-matter`: 用于解析 MDX frontmatter
- `@monaco-editor/react`: Monaco 编辑器（VS Code 编辑器核心）

## 访问编辑器

1. 确保已登录管理后台：访问 `/admin` 并输入密码
2. 登录后，可以通过以下方式访问编辑器：
   - 点击管理后台导航栏中的"文章编辑"链接
   - 点击右上角"编辑器"按钮
   - 直接访问 `/admin/editor`

## 编辑器功能

### 文件管理

- **文章列表**：左侧边栏显示所有文章，点击切换编辑
- **新建文章**：点击"+ 新建文章"按钮，输入标题创建新文章
- **删除文章**：点击元信息编辑器右侧的删除按钮

### 元信息编辑

- **标题**：必填字段
- **发布日期和更新日期**：使用日期选择器
- **描述**：多行文本输入
- **分类**：单个分类
- **标签**：多个标签，用逗号分隔
- **发布状态**：勾选框控制是否发布

### Markdown 编辑器

- **Monaco Editor**：完整的 VS Code 编辑器体验
- **语法高亮**：支持 Markdown 语法
- **自动换行**：代码自动换行显示
- **主题同步**：自动跟随系统暗色/亮色模式

### 实时预览

- **分屏预览**：右侧实时显示渲染效果
- **防抖渲染**：500ms 防抖，减少性能消耗
- **错误提示**：MDX 语法错误时显示错误信息
- **切换预览**：点击"显示预览/隐藏预览"按钮

### 草稿自动保存

- **自动保存**：每 30 秒自动保存草稿到 LocalStorage
- **草稿恢复**：切换文章时自动检测并询问是否恢复草稿
- **保存提示**：显示最后一次自动保存的时间
- **草稿清理**：正式保存后自动清除草稿

### 快捷键

- **`Cmd/Ctrl + S`**：保存当前文章
- 更多快捷键可在后续版本中添加

### 保存和发布

- **保存草稿**：点击"保存"按钮，保存但不发布
- **发布文章**：点击"发布"按钮，同时设置 `published: true` 并保存
- **未保存提示**：顶部显示"● 未保存的更改"

## 技术细节

### 文件结构

```
app/
├── admin/
│   └── editor/
│       ├── layout.tsx         # 权限保护
│       └── page.tsx           # 编辑器主页面

app/api/admin/posts/
├── route.ts                   # GET (列表) / POST (创建)
└── [slug]/
    └── route.ts               # GET (读取) / PUT (更新) / DELETE (删除)

components/admin/
├── mdx-editor.tsx             # Monaco 编辑器
├── mdx-preview.tsx            # MDX 实时预览
└── meta-editor.tsx            # 元信息表单

lib/
└── draft-storage.ts           # LocalStorage 草稿管理
```

### API 路由

#### 获取文章列表

```http
GET /api/admin/posts
```

#### 创建新文章

```http
POST /api/admin/posts
Content-Type: application/json

{
  "title": "文章标题"
}
```

#### 获取单篇文章

```http
GET /api/admin/posts/{slug}
```

#### 更新文章

```http
PUT /api/admin/posts/{slug}
Content-Type: application/json

{
  "frontmatter": {
    "title": "...",
    "date": "2026-01-12",
    ...
  },
  "content": "# 文章内容..."
}
```

#### 删除文章

```http
DELETE /api/admin/posts/{slug}
```

### 安全性

- 所有 API 都通过 JWT 验证身份
- 文件路径验证，防止目录遍历攻击
- 只能访问 `content/posts` 目录下的 `.mdx` 文件

### 性能优化

- Monaco Editor 按需加载
- 预览渲染防抖（500ms）
- 草稿保存节流（30秒）
- 自动布局调整

## 已知限制

1. **草稿存储**：使用 LocalStorage，仅在当前浏览器有效
2. **文件上传**：目前不支持图片直接上传，需要手动管理图片
3. **协作编辑**：不支持多人同时编辑同一文章
4. **版本控制**：不支持文章历史版本查看和恢复

## 后续改进方向

见计划文件第二、三、四阶段：

1. **系列文章功能**：支持文章系列导航
2. **图片管理系统**：拖拽上传、自动优化
3. **主题定制系统**：多种配色方案和布局选项

## 故障排除

### 编辑器无法加载

- 检查网络连接（Monaco Editor 从 CDN 加载）
- 清除浏览器缓存
- 检查控制台错误信息

### 保存失败

- 确认已登录且 Token 未过期
- 检查文件权限（`content/posts` 目录需要写权限）
- 查看服务器日志

### 预览渲染错误

- 检查 MDX 语法是否正确
- 查看浏览器控制台错误信息
- 尝试简化内容排查问题

### 草稿丢失

- 草稿存储在 LocalStorage，清除浏览器数据会丢失
- 定期保存到服务器（点击"保存"按钮）
- 考虑使用浏览器同步功能

## 使用建议

1. **定期保存**：虽然有自动草稿，但建议手动保存
2. **预览检查**：发布前在预览中确认格式正确
3. **备份重要内容**：可以复制到本地编辑器备份
4. **使用快捷键**：`Cmd/Ctrl + S` 快速保存
5. **合理使用标签**：标签用逗号分隔，便于分类

## 反馈和支持

如遇到问题或有改进建议，请在 GitHub 提 Issue。
